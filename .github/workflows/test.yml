name: test
run-name: ${{ github.actor }} - test 
on:  
  workflow_dispatch:
permissions:
  contents: read
  pages: write
  id-token: write 
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  setup: 
    runs-on: ubuntu-latest
    outputs:  
      response: ${{ steps.get-json.outputs.response }} 
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - id: get-json 
        run: |
          # Query GraphQL 
          queryGraphQL='query ($owner: String!, $repo: String!) { 
            repository(owner: $owner, name: $repo) { 
              discussionCategories(first: 10) { 
                nodes { 
                  id 
                  name 
                }
              } 
            }
          }'
          
          # Query Variables
          queryVariable='"owner": "jtorleon-studios-team", "repo": ".github"'
          
          # CURL request
          apiResponse=$(curl -X POST -H "Content-Type: application/vnd.github+json" -H "Authorization: token ${{ secrets.PAT }}" \
            -d "{ \"query\": \"$queryGraphQL\", \"variables\": { $queryVariable } }" https://api.github.com/graphql)

          # set output
          echo "response=$apiResponse" >> $GITHUB_OUTPUT
  parse-json:
    needs: setup
    runs-on: ubuntu-latest
    steps: 
      - run: |   
          categoryId=$(echo "${{ fromJson(needs.setup.outputs.response) }}" | jq -r '.data.repository.discussionCategories.nodes[] | select(.name == "General") | .id')
          echo "ID of General category: $categoryId"
